# DO2_LinuxNetwork

## Part 1. Инструмент ipcalc

#### 1.1. Сети и маски

![](images/1-1.png)  
- Определили адрес сети 192.167.38.54/13. (192.160.0.0)

<br>

![](images/1-2.png)  
- Перевод маски 255.255.255.0 в префиксную и двоичную запись
- В префиксной: /24 
- В двоичной: 11111111.11111111.11111111.00000000

<br>

![](images/1-3.png)  
- Перевод маски /15 в обычную и двоичную запись
- В обычной: 255.254.0.0
- В двоичной: 11111111.11111110.00000000.00000000

<br>

![](images/1-4.png)  
- Перевод маски 11111111.11111111.11111111.11110000 в обычную и префиксную
- В обычной: 255.255.255.240
- В префиксной: /28

<br>

![](images/1-5.png)  
- Минимальный и максимальный хост в сети 12.167.38.4 при маске /8

<br>

![](images/1-6.png)  
- Минимальный и максимальный хост в сети 12.167.38.4 при маске 11111111.11111111.00000000.00000000

<br>

![](images/1-7.png)  
- Минимальный и максимальный хост в сети 12.167.38.4 при маске 255.255.254.0

<br>

![](images/1-8.png)  
- Минимальный и максимальный хост в сети 12.167.38.4 при маске /4

#### 1.2. localhost

![](images/1-9.png)  
- Определили, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100 и 128.0.0.1 - нет, 127.0.0.2 и 127.1.0.1 -да 
<br>

#### 1.3. Диапазоны и сегменты сетей

Публичные ip:
- 134.43.0.2
- 172.0.2.1
- 192.172.0.1
- 172.68.0.2
- 192.169.168.1

Частные ip:
- 10.0.0.45
- 192.168.4.2
- 172.20.250.4
- 172.16.255.255
- 10.10.10.10

Какие IP адреса шлюза возможны у сети 10.10.0.0/18:

- 10.0.0.1
- 10.10.0.2 - возможен
- 10.10.10.10 - возможен
- 10.10.100.1
- 10.10.1.255 - возможен

<br>

## Part 2. Статическая маршрутизация между двумя машинами

![](images/1-10.png)
![](images/1-11.png) 
- С помощью команды ip a посмотрели существующие сетевые интерфейсы

<br>

![](images/2-1.png)  
- Описали сетевой интерфейс, соответствующий внутренней сети и задали адрес и маску на машине ws1

<br>

![](images/2-2.png)  
- Вызов команды netplan apply для перезапуска сервиса сети

<br>

![](images/2-3.png)  
- Описали сетевой интерфейс, соответствующий внутренней сети и задали адрес и маску на машине ws2

<br>

![](images/2-4.png)  
- Вызов команды netplan apply для перезапуска сервиса сети

<br>

#### 2.1. Добавление статического маршрута вручную

![](images/2-5.png)
- Добавили статические маршруты от ws1 до ws2 при помощи команды вида ip r add и пропинговали. (+  bзменили настройки сети в VB)

<br>

![](images/2-6.png)  
- Добавили статические маршруты от ws2 до ws1 при помощи команды вида ip r add и пропинговали. (+  bзменили настройки сети в VB)

<br>

#### 2.2. Добавление статического маршрута с сохранением


![](images/2-7.png)  
- Добавили статический маршрут от ws1 до ws2

<br>

![](images/2-8.png)  
- Добавили статический маршрут от ws2 до ws1

<br>

![](images/2-9.png) 

<br>

![](images/2-10.png)  
- Пропинговали соединение между машинами

<br>

## Part 3. Утилита iperf3

#### 3.1. Скорость соединения
- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 Kbps
- 1 Gbps = 1024 Mbps

<br>

#### 3.2. Утилита iperf3

![](images/3-1.png)  
- Скорость соединения между ws1 и ws2

<br>

![](images/3-2.png)  
- Скорость соединения между ws2 и ws1

<br>

## Part 4. Сетевой экран

#### 4.1. Утилита iptables

![](images/4-1.png)  
- Прописали правила с помощью утилиты iptables, открыли порты, запретили echo reply, разрешили echo reply

<br>

![](images/4-2.png)  
- Запустили файл на машине ws1

<br>

![](images/4-3.png)  
- Прописали правила с помощью утилиты iptables, открыли порты, разрешили echo reply, запретили echo reply
- Если сначала стоит запрещающее правило, то оно имеет приоритет перед последующим разрешающим

<br>

![](images/4-4.png)  
- Запустили файл на машине ws2

<br>

#### 4.2. Утилита nmap

![](images/4-5.png)  
- ws1 пингуется с ws2.

<br>

![](images/4-6.png)  
- ws2 не пингуется c w1, но порт открыт (Host is up)

<br>

## Part 5. Статическая маршрутизация сети

![](images/5-1.png)  
- Файл 00-installer-config.yaml для ws11.

<br>

![](images/5-2.png)  
- Файл 00-installer-config.yaml для ws21.

<br>

![](images/5-3.png)  
- Файл 00-installer-config.yaml для ws22.

<br>

![](images/5-4.png)  
- Файл 00-installer-config.yaml для r1.

<br>

![](images/5-5.png)  
- Файл 00-installer-config.yaml для r2.

<br>

![](images/5-6.png)  
- Командой ip -4 a проверили, что адрес машины w11 задан верно

<br>

![](images/5-7.png)  
- Командой ip -4 a проверили, что адрес машины w21 задан верно

<br>

![](images/5-8.png)  
- Командой ip -4 a проверили, что адрес машины w22 задан верно

<br>

![](images/5-9.png) 
- Командой ip -4 a проверили, что адрес машины r1 задан верно

<br>

![](images/5-10.png) 
- Командой ip -4 a проверили, что адрес машины r2 задан верно

<br>

![](images/5-11.png) 
- Пропинговали ws22 с ws21
<br>

![](images/5-12.png) 
- Пропинговали r1 с ws11

<br>

#### 5.2. Включение переадресации IP-адресов

![](images/5-13.png) 
- Для включения переадресации IP для r1 выполнили команду `sysctl -w net.ipv4.ip_forward=1`

<br>

![](images/5-14.png) 
- Для включения переадресации IP для r2 выполнили команду `sysctl -w net.ipv4.ip_forward=1`

<br>

![](images/5-15.png)
- Открыли файл /etc/sysctl.conf и добавили в него net.ipv4.ip_forward = 1 для r1 (ip переадресация включена на постоянной основе)

<br>

![](images/5-16.png)  
- Открыли файл /etc/sysctl.conf и добавили в него net.ipv4.ip_forward = 1 для r2

<br>

#### 5.3. Установка маршрута по умолчанию

![](images/5-17.png) 
- Добавили default перед IP-роутера в файле конфигураций ws11

<br>

![](images/5-18.png) 
- Добавили default перед IP-роутера в файле конфигураций ws21

<br>

![](images/5-19.png) 
- Добавили default перед IP-роутера в файле конфигураций ws22

<br>

![](images/5-20.png) 
- Вызвали ip r, добавился маршрут в таблицу маршрутизации ws11

<br>

![](images/5-21.png)  
- Вызвали ip r, добавился маршрут в таблицу маршрутизации ws21

<br>

![](images/5-22.png)  
- Вызвали ip r, добавился маршрут в таблицу маршрутизации ws22

<br>

![](images/5-24.png)  
- Пропинговали с ws11 роутер r2

<br>

![](images/5-25.png)  
- Проверили что пинг доходит командой tcpdump -tn -i enp0s3

<br>

#### 5.4. Добавление статических маршрутов

![](images/5-26.png)  
-  Добавили в r1 статические маршруты в файле конфигураций

<br>

![](images/5-27.png)  
- Добавили в r2 статические маршруты в файле конфигураций

<br>

![](images/5-28.png)  
- Показали таблицу с маршрутами на r1

<br>

![](images/5-29.png)  
- Показали таблицу с маршрутами на r2

<br>

![](images/5-30.png)  
- Запустили команды на ws11
- Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, потому что он является адресом сети и доступен без шлюза.

<br>

#### 5.5. Построение списка маршрутизаторов


![](images/5-31.png)  
- Запустили команду traceroute на ws11(путь lj ws21)

<br>

![](images/5-32.png)  
- Запустили на r1 команду дампа `sudo tcpdump -tnv -i enp0s3`
- Утилита Traceroute отправляет три UDP-пакета на указанный порт целевого хоста, ожидая ответа о том, что этот порт недоступен. Для каждого пакета используется увеличивающееся значение TTL: первый отправляется с TTL=1, второй с TTL=2 и так далее, пока пакет не достигнет адресата. В отличие от ICMP-запроса, Traceroute отправляет UDP-запросы, которые включают порты отправителя и получателя. По умолчанию, запросы направляются на закрытый порт 34434. Когда пакет достигает целевого хоста, он отвечает сообщением «Destination port unreachable» (порт назначения недоступен), что указывает на успешное получение запроса адресатом. Traceroute интерпретирует этот ответ как завершение трассировки.

<br>

#### 5.6. Использование протокола ICMP при маршрутизации

![](images/5-33.png)  
- Пропинговали с ws11 несуществующий IP

<br>

![](images/5-34.png)  
- Запустили на r1 перехват сетевого трафика, проходящего через enp0s3

<br>

## Part 6. Динамическая настройка IP с помощью DHCP

![](images/6-1.png)  
- Указали адрес маршрутизатора по умолчанию, DNS-сервер и адрес внутренней сети для r2

<br>

![](images/6-2.png)  
- В файле resolv.conf прописали nameserver 8.8.8.8

<br>


- Перезагрузка службы DHCP командой `systemctl restart isc-dhcp-server`

<br>

![](images/6-4.png)  
- Через ip a показали, что машина ws21 получила адрес

<br>

![](images/6-5.png)  
- Пропинговали ws22 с ws21

<br>

![](images/6-6.png)  
- Указали MAC-адрес у ws11

<br>

![](images/6-7.png) 
- Настройка r1 (с жесткой привязкой к MAC адресу)

<br>

![](images/6-8.png) 
- Настройка DNS r1

<br>

![](images/6-8.png)   
- Перезагрузка службы DHCP командой `systemctl restart isc-dhcp-server`

<br>

![](images/6-10.png)  
- ws11 ip a после перезагрузки получили ip

<br>

![](images/6-11.png)  
- ip ws21 до обновления

<br>

![](images/6-12.png)  
- ip ws21 после обновления
- sudo dhclient -r enp0s3 освободила текущий адрес интерфейса enp0s3
- sudo dhclient enp0s3 задает новый адрес указанному интерфейсу

<br>

## Part 7. NAT

![](images/6-13.png)  
- На ws22 изменили строку Listen 80 на Listen 0.0.0.0:80, сделали сервер Apache2 общедоступным

<br>

![](images/7-1.png)  
- На r1 изменили строку Listen 80 на Listen 0.0.0.0:80, сделали сервер Apache2 общедоступным

<br>

![](images/7-2.png)  
- Запуск серверов Apache2 на r1 и ws22

<br>

![](images/7-3.png)  
- Добавление в фаервол на r2 следующих правил

<br>


![](images/7-3-1.png)  
- Сначала пинг с ws22 до r1 не удался

<br>

![](images/7-4.png)
- Проверка соединения между ws22 и r1 командой ping. После разрешения маршрутизации icmp на r2 пинг успешен

<br>

![](images/7-5.png)
- Разрешение маршрутизации icmp на r2

<br>

![](images/7-6.png)  
- Включили SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (сеть 10.20.0.0)
- Включили DNAT на 8080 порт машины r2 и добавили к веб-серверу Apache, запущенному на ws22, доступ извне сети

<br>

![](images/7-7.png)  
- Проверка соединения по TCP для SNAT, для этого с ws22 подключились к серверу Apache на r1

<br>

![](images/7-8.png)  
- Проверка соединения по TCP для DNAT, для этого с r1 подключились к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)